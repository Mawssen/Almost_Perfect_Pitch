<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>APP: Almost Perfect Pitch üçëüéµ</title>
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    body { margin:0; padding:24px; background:#0b0f19; color:#e8ecf1; }

    /* Title outside the box */
    .page-title{
      text-align:center;
      font-size: 36px;
      font-weight: 800;
      letter-spacing: 0.5px;
      color:#7aa8ff;
      margin: 6px 0 18px;
    }

    .card { max-width:900px; margin:0 auto; background:#121a2b; border:1px solid #22304f; border-radius:14px; padding:18px; position:relative; }
    h1 { margin:0 0 10px; font-size:20px; } /* (kept but unused for the card title) */
    .row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .pill { padding:4px 10px; border-radius:999px; border:1px solid #2a3a61; background:#0f1627; font-size:13px; opacity:0.95; }
    .prompt { font-size:18px; margin:12px 0 14px; line-height:1.35; }
    button {
      border:1px solid #2a3a61; background:#17223a; color:#e8ecf1;
      padding:10px 12px; border-radius:12px; cursor:pointer; font-size:14px;
    }
    button:hover { filter:brightness(1.1); }
    button:disabled { opacity:0.55; cursor:not-allowed; }
    .choice { min-width:220px; text-align:left; }
    .choice.choice-jens { text-align:center; }
    .row.choices-jens { flex-direction:column; }
    .ok { border-color:#2c7a4b; background:#153524; }
    .bad { border-color:#8a2e2e; background:#3a1616; }
    .hint-eliminated { opacity:0.5; cursor:not-allowed; pointer-events:none; }
    .status { margin-top:12px; font-size:14px; min-height:20px; white-space:pre-line; }
    .divider { height:1px; background:#22304f; margin:14px 0; }
    .small { font-size:12px; opacity:0.8; margin-top:12px; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; }

    /* Main menu: four buttons centered, stacked */
    .main-menu { display:flex; flex-direction:column; align-items:center; gap:10px; margin:12px 0; }
    .main-menu button { min-width:200px; }
    .main-menu.hidden { display:none; }
    /* Settings panel */
    .settings-panel { display:none; border:1px solid #22304f; border-radius:14px; padding:10px 12px; background:#0f1627; margin-bottom:14px; }
    .settings-panel.visible { display:block; }
    .settings-back-row { margin-bottom:12px; display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
    .stats-line { margin:6px 0; font-size:14px; }
    .stats-modal { position:fixed; inset:0; background:rgba(0,0,0,0.6); display:none; align-items:center; justify-content:center; z-index:100; padding:24px; box-sizing:border-box; }
    .stats-modal.visible { display:flex; }
    .stats-modal-content { background:#121a2b; border:1px solid #22304f; border-radius:14px; padding:24px; max-width:480px; max-height:85vh; overflow:auto; }
    .stats-modal h2 { margin:0 0 12px; font-size:18px; color:#7aa8ff; }
    .stats-modal .hint { margin-top:12px; }
    .stats-modal-actions { margin-top:16px; display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .stats-modal-close { margin:0; }
    .stats-clear-btn { border-color:#6b2a2a; background:#2a1616; color:#e8a0a0; }
    .stats-clear-btn:hover { filter:brightness(1.15); }
    .grid { display:grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
    .field { display:flex; flex-direction:column; gap:6px; }
    label { font-size:13px; opacity:0.9; }
    select, input[type="number"]{
      border:1px solid #2a3a61; background:#17223a; color:#e8ecf1;
      padding:8px 10px; border-radius:10px; font-size:14px;
    }
    .scale-list { display:flex; flex-direction:column; gap:6px; max-height: 240px; overflow:auto; padding-right: 6px; }
    .chk { display:flex; gap:8px; align-items:flex-start; }
    .chk input { margin-top: 3px; }
    .actions { margin-top: 10px; display:flex; gap:10px; flex-wrap:wrap; }
    .hint { font-size:12px; opacity:0.8; }
    .pill.revealable { cursor:pointer; user-select:none; }
    .pill.revealable:hover { filter:brightness(1.1); }
    .mode-btn { min-width:160px; }
    .test-area { display:none; }
    .test-area.visible { display:flex; flex-direction:column; align-items:center; }
    .test-area .row { justify-content:center; }
    .test-area .prompt { text-align:center; }
    .test-area .status { text-align:center; }
    .test-area .small { text-align:center; }
    .test-area .divider { align-self:stretch; }
    .test-area.done .notes-played-row { display:none; }
    .final-score-display { display:none; text-align:center; font-size:1.75rem; font-weight:800; color:#7aa8ff; margin:16px 0 8px; }
    .test-area.done .final-score-display { display:block; }
    .done-message { display:none; text-align:center; margin:12px 0; font-weight:700; }
    .test-area.done .done-message { display:block; }
    .done-message.perfect { font-size:2.5rem; font-weight:800; color:#2c7a4b; }
    .done-message.great { font-size:1.75rem; color:#5a9f5a; }
    .done-message.good { font-size:1.35rem; color:#8fbc8f; }
    .done-message.shy { font-size:1rem; font-weight:normal; opacity:0.95; }
    .card-wrapper { width:100%; max-width:900px; margin:0 auto; position:relative; }
    .card-wrapper .card { margin:0; }
    .help-btn { margin:0; }
    .help-modal { position:fixed; inset:0; background:rgba(0,0,0,0.6); display:none; align-items:center; justify-content:center; z-index:100; padding:24px; box-sizing:border-box; }
    .help-modal.visible { display:flex; }
    .help-modal-content { background:#121a2b; border:1px solid #22304f; border-radius:14px; padding:24px; max-width:480px; max-height:85vh; overflow:auto; }
    .help-modal h2 { margin:0 0 12px; font-size:18px; color:#7aa8ff; }
    .help-modal h3 { margin:16px 0 8px; font-size:14px; opacity:0.95; }
    .help-modal p, .help-modal ul { margin:0 0 10px; font-size:14px; line-height:1.5; }
    .help-modal ul { padding-left:20px; }
    .help-modal kbd { background:#17223a; border:1px solid #2a3a61; border-radius:4px; padding:2px 6px; font-size:12px; }
    .help-modal-close { margin-top:16px; }
    /* Learn modal */
    .learn-modal { position:fixed; inset:0; background:rgba(0,0,0,0.6); display:none; align-items:center; justify-content:center; z-index:100; padding:24px; box-sizing:border-box; }
    .learn-modal.visible { display:flex; }
    .learn-modal-content { background:#121a2b; border:1px solid #22304f; border-radius:14px; padding:24px; max-width:560px; max-height:90vh; overflow:auto; width:100%; }
    .learn-header { display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:12px; margin-bottom:12px; }
    .learn-modal h2 { margin:0; font-size:18px; color:#7aa8ff; }
    .learn-tonic-row { display:flex; align-items:center; gap:8px; }
    .learn-tonic-row label { font-size:13px; opacity:0.9; }
    .learn-tonic-row select { padding:6px 8px; font-size:13px; min-width:72px; border:1px solid #2a3a61; background:#17223a; color:#e8ecf1; border-radius:10px; }
    .learn-tabs { display:flex; gap:8px; margin-bottom:14px; }
    .learn-tabs button { padding:8px 14px; border-radius:10px; }
    .learn-tabs button.active { border-color:#7aa8ff; background:#1a2a4a; color:#7aa8ff; }
    .learn-list { display:flex; flex-direction:column; gap:14px; }
    .learn-item { border:1px solid #22304f; border-radius:10px; padding:12px 14px; background:#0f1627; }
    .learn-item-title { font-weight:700; font-size:15px; margin-bottom:4px; }
    .learn-item-pattern { font-family:ui-monospace, monospace; font-size:13px; opacity:0.9; margin-bottom:6px; }
    .learn-item-desc { font-size:13px; opacity:0.85; margin-bottom:10px; line-height:1.4; }
    .learn-item-play-row { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .learn-modal-close { margin-top:16px; }
    @media (max-width: 720px) {
      .grid { grid-template-columns: 1fr; }
      .choice { min-width: 100%; }
    }
  </style>

  <!-- SoundFont player (piano in the browser) -->
  <script src="https://unpkg.com/soundfont-player@0.12.0/dist/soundfont-player.js"></script>
</head>
<body>
  <div class="page-title">APP: Almost Perfect Pitch üçëüéµ</div>

  <div class="card-wrapper">
  <div class="card">
    <div class="settings-panel" id="settingsPanel">
      <div class="settings-back-row">
        <button type="button" id="settingsBackBtn">‚Üê Back</button>
        <button type="button" id="statsBtn">Stats</button>
      </div>
      <div class="grid">
        <div class="field">
          <label for="lowestNote">Lowest note (C2‚ÄìC6)</label>
          <select id="lowestNote"></select>
          <div class="hint">Start note is picked uniformly between Lowest and Highest.</div>
        </div>

        <div class="field">
          <label for="highestNote">Highest note (C2‚ÄìC6)</label>
          <select id="highestNote"></select>
          <div class="hint">If Lowest &gt; Highest, they will be swapped internally.</div>
        </div>

        <div class="field">
          <label for="directionMode">Direction</label>
          <select id="directionMode">
            <option value="random" selected>Random (up/down)</option>
            <option value="up">Up only</option>
            <option value="down">Down only</option>
          </select>
        </div>

        <div class="field">
          <label for="totalTests">Total tests</label>
          <input id="totalTests" type="number" min="1" step="1" value="5" />
        </div>
      </div>

      <div class="divider"></div>

      <div class="field">
        <label>Scales to include</label>
        <div class="actions">
          <button id="selectAllBtn" type="button">Select all</button>
          <button id="selectNoneBtn" type="button">Select none</button>
        </div>
        <div class="scale-list" id="scaleChecklist"></div>
        <div class="hint">If none are selected, Scale test will refuse to start.</div>
      </div>

      <div class="divider"></div>

      <div class="field">
        <label>Jens (tetrachords) to include</label>
        <div class="actions">
          <button id="selectAllJensBtn" type="button">Select all</button>
          <button id="selectNoneJensBtn" type="button">Select none</button>
        </div>
        <div class="scale-list" id="jensChecklist"></div>
        <div class="hint">If none are selected, Jens test will refuse to start.</div>
      </div>

      <div class="actions">
        <button id="applySettingsBtn" type="button">Apply settings</button>
      </div>
    </div>

    <div class="main-menu" id="mainMenu">
      <button type="button" class="mode-btn" id="scaleTestBtn">Scale test</button>
      <button type="button" class="mode-btn" id="jensTestBtn">Jens test</button>
      <button type="button" id="learnBtn">Learn</button>
      <button type="button" id="settingsBtn">Settings</button>
      <button type="button" class="help-btn" id="helpBtn">Help</button>
    </div>

    <div class="test-area" id="testArea">
    <div class="row" style="margin:12px 0 10px;">
      <span class="pill" id="testMeta">Test: 0 / 10</span>
      <span class="pill" id="scoreMeta">Score: 0</span>
      <span class="pill revealable" id="dirMeta" title="Click to reveal">Direction: ?</span>
      <span class="pill revealable" id="startMeta" title="Click to reveal">Start: ?</span>
    </div>

    <div class="prompt" id="prompt">Press "Start Test" to begin.</div>

    <div class="row">
      <button id="startBtn">Start Test</button>
      <button id="replayBtn" disabled>Replay</button>
      <button id="hintBtn" disabled>Hint</button>
      <button id="nextBtn" disabled>Next</button>
      <button id="restartBtn">Exit</button>
    </div>

      <div class="divider"></div>

      <div class="row" id="choices"></div>
      <div id="finalScoreDisplay" class="final-score-display"></div>
      <div class="status" id="status"></div>
      <div id="doneMessage" class="done-message"></div>
      <div class="small notes-played-row" id="notesPlayedRow">
        Notes played: <span class="mono" id="notesOut">-</span>
      </div>
    </div>
    </div>
  </div>
  </div>

  <div class="stats-modal" id="statsModal" aria-hidden="true">
    <div class="stats-modal-content">
      <h2>Your stats</h2>
      <div id="statsNaturally" class="stats-line"></div>
      <div id="statsHard" class="stats-line"></div>
      <p class="hint">Based on correct and wrong answers across all tests. Wrong answers are weighted so you'll see them more often if you get them wrong more often.</p>
      <div class="stats-modal-actions">
        <button type="button" class="stats-modal-close" id="statsModalClose">Close</button>
        <button type="button" class="stats-clear-btn" id="statsClearHistoryBtn">Clear history</button>
      </div>
    </div>
  </div>

  <div class="learn-modal" id="learnModal" aria-hidden="true">
    <div class="learn-modal-content">
      <div class="learn-header">
        <h2>Learn scales &amp; jens</h2>
        <div class="learn-tonic-row">
          <label for="learnTonicSelect">Tonic:</label>
          <select id="learnTonicSelect"></select>
          <label for="learnDirectionSelect">Direction:</label>
          <select id="learnDirectionSelect">
            <option value="up">Up</option>
            <option value="down">Down</option>
          </select>
        </div>
      </div>
      <div class="learn-tabs">
        <button type="button" id="learnTabScales" class="learn-tab active">Scales</button>
        <button type="button" id="learnTabJens" class="learn-tab">Jens</button>
      </div>
      <div id="learnList" class="learn-list"></div>
      <button type="button" class="learn-modal-close" id="learnModalClose">Close</button>
    </div>
  </div>

  <div class="help-modal" id="helpModal" aria-hidden="true">
    <div class="help-modal-content">
      <h2>How the app works</h2>
      <p>Choose <strong>Scale test</strong> or <strong>Jens test</strong>. In Settings you can set the note range, direction (up/down/random), number of tests, and which scales or jens (tetrachords) to include.</p>
      <p>Press <strong>Start Test</strong> to begin. A scale or jens is played on the piano; pick the correct answer from the choices. Use <strong>Replay</strong> to hear it again, <strong>Hint</strong> to lock half+1 of the wrong choices (once per question), and <strong>Next</strong> to continue. <strong>Exit</strong> returns to the mode selection.</p>
      <p>Click the <strong>Direction</strong> and <strong>Start</strong> pills to reveal the playing direction and starting note for the current question.</p>

      <h3>Keyboard shortcuts</h3>
      <ul>
        <li><kbd>Space</kbd> ‚Äî Replay</li>
        <li><kbd>Enter</kbd> ‚Äî Start test (when on first screen) or Next (after answering)</li>
        <li><kbd>1</kbd>‚Äì<kbd>9</kbd> ‚Äî Select choice 1‚Äì9</li>
        <li><kbd>-</kbd> ‚Äî Select choice 10</li>
        <li><kbd>Esc</kbd> ‚Äî Close modal, back from Settings, or exit test</li>
      </ul>
      <!-- End of Selection -->
      <button type="button" class="help-modal-close" id="helpModalClose">Close</button>
    </div>
  </div>

  <script>
    // ===== Your scales (same content as Python) =====
    const SCALES = [
      { id: 1,  name: "Major (Ajam + Ajam)",                   intervals: [2,2,1,2,2,2,1], description: "Bright, happy; the default Western major scale." },
      { id: 2,  name: "Dorian (Nahavand + Nahavand)",          intervals: [2,1,2,2,2,1,2], description: "Minor with raised sixth; jazzy, smooth." },
      { id: 3,  name: "Major Double Harmonic (Hejaz + Hejaz)", intervals: [1,3,1,2,1,3,1], description: "Eastern, dramatic; augmented second." },
      { id: 4,  name: "Phrygian (Kord + Kord)",                intervals: [1,2,2,2,1,2,2], description: "Dark, Spanish; lowered second." },
      { id: 5,  name: "Minor Theoric (Nahavand + Kord)",       intervals: [2,1,2,2,1,2,2], description: "Natural minor; sad, classical." },
      { id: 6,  name: "Minor Harmonic (Nahavand + Hejaz)",     intervals: [2,1,2,2,1,3,1], description: "Minor with raised seventh; tense, dramatic." },
      { id: 7,  name: "Minor Melodic (Nahavand + Ajam)",       intervals: [2,1,2,2,2,2,1], description: "Jazz minor; ascending form." },
      { id: 8,  name: "Major Harmonic (Ajam + Hejaz)",         intervals: [2,2,1,2,1,3,1], description: "Exotic major; augmented second." },
      { id: 9,  name: "Pentatonic Major",                      intervals: [2,2,3,2,3], description: "Five notes; bright, open; no half steps." },
      { id: 10, name: "Pentatonic Minor",                      intervals: [3,2,2,3,2], description: "Five notes; bluesy, rock; no half steps." }
    ];

    // ===== Jenses (tetrachords and related segments) =====
    const JENSES = [
      { id: "ajam",     name: "Ajam",           intervals: [2, 2, 1],   description: "Major tetrachord; whole-whole-half." },
      { id: "hejaz",    name: "Hejaz",          intervals: [1, 3, 1],   description: "Harmonic/flamenco; half-augmented-half." },
      { id: "nahavand", name: "Nahavand",       intervals: [2, 1, 2],   description: "Dorian lower tetrachord; whole-half-whole." },
      { id: "kord",     name: "Kord",           intervals: [1, 2, 2],   description: "Phrygian lower tetrachord; half-whole-whole." },
      { id: "saba-zamzam", name: "Saba-Zamzam",  intervals: [1, 2, 1],   description: "Saba-Zamzam tetrachord; half-whole-half, characteristic of Saba maqam." },
      { id: "nava-asar",   name: "Nava-Asar",   intervals: [2, 1, 3, 1], description: "Nava-Asar; five-note segment, common in Nava and related contexts." },
      { id: "asar-kord",   name: "Asar-Kord",   intervals: [1, 2, 3, 1], description: "Asar-Kord; five-note segment, bridging Asar and Kord character." }
    ];
    const DEFAULT_ENABLED_JENS_IDS = ["ajam", "hejaz", "nahavand", "kord"];

    // ===== Helpers =====
    function buildScaleMidi(startMidi, intervals) {
      const notes = [startMidi];
      let current = startMidi;
      for (const interval of intervals) {
        current += interval;
        notes.push(current);
      }
      return notes;
    }

    function midiToNoteName(midi) {
      const names = ["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];
      const octave = Math.floor(midi / 12) - 1;
      const note = names[midi % 12];
      return `${note}${octave}`;
    }

    function noteNameToMidi(noteName) {
      // expects e.g. "C#3", "D4"
      const names = ["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];
      const m = /^([A-G]#?)(\d)$/.exec(noteName);
      if (!m) return 60;
      const pitch = m[1];
      const octave = Number(m[2]);
      const idx = names.indexOf(pitch);
      return (octave + 1) * 12 + idx;
    }

    function clampInt(x, lo, hi) {
      const v = Math.trunc(Number(x));
      if (Number.isNaN(v)) return lo;
      return Math.min(Math.max(v, lo), hi);
    }

    function randIntInclusive(lo, hi) {
      return lo + Math.floor(Math.random() * (hi - lo + 1));
    }

    // ===== Fixed playback settings (not shown in UI) =====
    const DEFAULT_NOTE_DURATION_SEC = 0.5;
    const DEFAULT_PAUSE_DURATION_SEC = 0.05;

    // ===== SoundFont piano =====
    let audioCtx = null;
    let piano = null;

    function ensureAudio() {
      if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      return audioCtx;
    }

    async function ensurePiano() {
      const ctx = ensureAudio();
      if (ctx.state === "suspended") await ctx.resume();
      if (!piano) {
        piano = await Soundfont.instrument(ctx, "acoustic_grand_piano", {
          soundfont: "MusyngKite",
          format: "mp3"
        });
      }
      return piano;
    }

    async function sleep(ms) {
      return new Promise(res => setTimeout(res, ms));
    }

    async function playScale(midiNotes, noteDurationSec, pauseDurationSec) {
      const ctx = ensureAudio();
      const inst = await ensurePiano();

      for (const midi of midiNotes) {
        if (playbackCancelled) return;
        inst.play(midi, ctx.currentTime, {
          duration: noteDurationSec,
          gain: 0.8,
          velocity: 110
        });
        await sleep(noteDurationSec * 1000);
        if (playbackCancelled) return;
        await sleep(pauseDurationSec * 1000);
      }
    }

    let learnPlaySessionId = 0;
    async function playScaleForLearn(midiNotes, sessionId, noteDurationSec, pauseDurationSec) {
      const ctx = ensureAudio();
      const inst = await ensurePiano();
      for (const midi of midiNotes) {
        if (learnPlaySessionId !== sessionId) return;
        inst.play(midi, ctx.currentTime, {
          duration: noteDurationSec,
          gain: 0.8,
          velocity: 110
        });
        await sleep(noteDurationSec * 1000);
        if (learnPlaySessionId !== sessionId) return;
        await sleep(pauseDurationSec * 1000);
      }
    }

    // ===== Settings state =====
    const SETTINGS_STORAGE_KEY = "scaleEarTrainerSettings";
    const STATS_STORAGE_KEY = "scaleEarTrainerStats";
    let scaleStats = {}; // scaleId -> { correct, wrong }
    let jensStats = {};  // jensId -> { correct, wrong }
    const settings = {
      lowestMidi: noteNameToMidi("G2"), // default lowest
      highestMidi: noteNameToMidi("D4"), // default highest
      directionMode: "random", // "random" | "up" | "down"
      totalTests: 5,
      enabledScaleIds: new Set(SCALES.map(s => s.id)),
      enabledJensIds: new Set(DEFAULT_ENABLED_JENS_IDS)
    };

    function loadSettingsFromStorage() {
      try {
        const raw = localStorage.getItem(SETTINGS_STORAGE_KEY);
        if (!raw) return;
        const data = JSON.parse(raw);
        if (data.lowestMidi != null) settings.lowestMidi = clampInt(data.lowestMidi, 0, 127);
        if (data.highestMidi != null) settings.highestMidi = clampInt(data.highestMidi, 0, 127);
        if (data.directionMode === "up" || data.directionMode === "down" || data.directionMode === "random") settings.directionMode = data.directionMode;
        if (data.totalTests != null) settings.totalTests = clampInt(data.totalTests, 1, 1000000);
        if (Array.isArray(data.enabledScaleIds)) {
          const ids = data.enabledScaleIds.map(Number).filter(id => SCALES.some(s => s.id === id));
          settings.enabledScaleIds = new Set(ids.length ? ids : SCALES.map(s => s.id));
        }
        if (Array.isArray(data.enabledJensIds)) {
          const ids = data.enabledJensIds.filter(id => JENSES.some(j => j.id === id));
          settings.enabledJensIds = new Set(ids.length ? ids : DEFAULT_ENABLED_JENS_IDS);
        }
      } catch (e) { /* ignore */ }
    }

    function loadStatsFromStorage() {
      try {
        const raw = localStorage.getItem(STATS_STORAGE_KEY);
        if (!raw) return;
        const data = JSON.parse(raw);
        if (data.scaleStats && typeof data.scaleStats === "object") scaleStats = data.scaleStats;
        if (data.jensStats && typeof data.jensStats === "object") jensStats = data.jensStats;
      } catch (e) { /* ignore */ }
    }

    function saveStatsToStorage() {
      try {
        localStorage.setItem(STATS_STORAGE_KEY, JSON.stringify({
          scaleStats,
          jensStats
        }));
      } catch (e) { /* ignore */ }
    }

    function clearStatsHistory() {
      scaleStats = {};
      jensStats = {};
      saveStatsToStorage();
      refreshStatsDisplay();
    }

    function saveSettingsToStorage() {
      try {
        localStorage.setItem(SETTINGS_STORAGE_KEY, JSON.stringify({
          lowestMidi: settings.lowestMidi,
          highestMidi: settings.highestMidi,
          directionMode: settings.directionMode,
          totalTests: settings.totalTests,
          enabledScaleIds: [...settings.enabledScaleIds],
          enabledJensIds: [...settings.enabledJensIds]
        }));
      } catch (e) { /* ignore */ }
    }

    // ===== App state =====
    let testIndex = 0;
    let correctCount = 0;
    let mistakes = []; // { correctId, wrongId } per wrong answer

    let testMode = null; // null | "scale" | "jens"
    let current = null; // scale: {scale, chosenScaleId, ...} | jens: {jens, chosenJensId, ...}
    let answered = false;
    let directionRevealed = false;
    let startRevealed = false;
    let hintUsed = false;
    let isPlaying = false;
    let playbackCancelled = false;

    // ===== UI elements =====
    const testMeta = document.getElementById("testMeta");
    const scoreMeta = document.getElementById("scoreMeta");
    const dirMeta = document.getElementById("dirMeta");
    const startMeta = document.getElementById("startMeta");

    const promptEl = document.getElementById("prompt");
    const choicesEl = document.getElementById("choices");
    const statusEl = document.getElementById("status");
    const notesOut = document.getElementById("notesOut");

    const mainMenu = document.getElementById("mainMenu");
    const testArea = document.getElementById("testArea");
    const scaleTestBtn = document.getElementById("scaleTestBtn");
    const jensTestBtn = document.getElementById("jensTestBtn");
    const startBtn = document.getElementById("startBtn");
    const replayBtn = document.getElementById("replayBtn");
    const hintBtn = document.getElementById("hintBtn");
    const nextBtn = document.getElementById("nextBtn");
    const restartBtn = document.getElementById("restartBtn");

    // Settings UI elements
    const lowestNoteEl = document.getElementById("lowestNote");
    const highestNoteEl = document.getElementById("highestNote");
    const directionModeEl = document.getElementById("directionMode");
    const totalTestsEl = document.getElementById("totalTests");
    const scaleChecklistEl = document.getElementById("scaleChecklist");
    const jensChecklistEl = document.getElementById("jensChecklist");
    const selectAllBtn = document.getElementById("selectAllBtn");
    const selectNoneBtn = document.getElementById("selectNoneBtn");
    const selectAllJensBtn = document.getElementById("selectAllJensBtn");
    const selectNoneJensBtn = document.getElementById("selectNoneJensBtn");
    const applySettingsBtn = document.getElementById("applySettingsBtn");

    function setMeta() {
      testMeta.textContent = `Test: ${testIndex} / ${settings.totalTests}`;
      scoreMeta.textContent = `Score: ${correctCount}`;
      const dirVal = current ? current.direction : "-";
      const startVal = current ? midiToNoteName(current.startMidi) : "-";
      dirMeta.textContent = current ? (directionRevealed ? `Direction: ${dirVal}` : "Direction: ?") : "Direction: -";
      startMeta.textContent = current ? (startRevealed ? `Start: ${startVal}` : "Start: ?") : "Start: -";
      startBtn.style.display = (testIndex === 0) ? "" : "none";
    }

    function clearChoices() {
      choicesEl.innerHTML = "";
    }

    function renderChoices() {
      clearChoices();
      if (!current) return;

      if (testMode === "scale") {
        choicesEl.className = "row";
        for (const s of current.availableScales) {
          const b = document.createElement("button");
          b.className = "choice";
          b.textContent = `${s.id}: ${s.name}`;
          b.disabled = answered;
          b.addEventListener("click", () => handleGuess(s.id, b));
          choicesEl.appendChild(b);
        }
      } else {
        choicesEl.className = "row choices-jens";
        current.availableJenses.forEach((j, i) => {
          const b = document.createElement("button");
          b.className = "choice choice-jens";
          b.dataset.jensId = j.id;
          b.textContent = `${i + 1}: ${j.name}`;
          b.disabled = answered;
          b.addEventListener("click", () => handleGuess(j.id, b));
          choicesEl.appendChild(b);
        });
      }
    }

    function lockChoices() {
      [...choicesEl.querySelectorAll("button")].forEach(b => b.disabled = true);
    }

    function getEnabledScales() {
      return SCALES.filter(s => settings.enabledScaleIds.has(s.id));
    }

    function getEnabledJenses() {
      return JENSES.filter(j => settings.enabledJensIds.has(j.id));
    }

    function pickDirection() {
      if (settings.directionMode === "up") return "up";
      if (settings.directionMode === "down") return "down";
      return (Math.random() < 0.5) ? "up" : "down";
    }

    function pickWeighted(items, getWeight) {
      const weights = items.map(getWeight);
      const total = weights.reduce((a, b) => a + b, 0);
      if (total <= 0) return items[Math.floor(Math.random() * items.length)];
      let r = Math.random() * total;
      for (let i = 0; i < items.length; i++) {
        r -= weights[i];
        if (r < 0) return items[i];
      }
      return items[items.length - 1];
    }

    const STATS_MIN_ATTEMPTS = 3;

    function refreshStatsDisplay() {
      const naturallyEl = document.getElementById("statsNaturally");
      const hardEl = document.getElementById("statsHard");
      if (!naturallyEl || !hardEl) return;

      const enough = (s) => ((s.correct || 0) + (s.wrong || 0)) >= STATS_MIN_ATTEMPTS;

      const topScaleByCorrect = () => {
        const entries = Object.entries(scaleStats).filter(([, s]) => enough(s));
        if (entries.length === 0) return null;
        const maxCorrect = Math.max(...entries.map(([, s]) => s.correct || 0));
        const top = entries.find(([, s]) => (s.correct || 0) === maxCorrect);
        return top ? Number(top[0]) : null;
      };
      const topJensByCorrect = () => {
        const entries = Object.entries(jensStats).filter(([, s]) => enough(s));
        if (entries.length === 0) return null;
        const maxCorrect = Math.max(...entries.map(([, s]) => s.correct || 0));
        const top = entries.find(([, s]) => (s.correct || 0) === maxCorrect);
        return top ? top[0] : null;
      };
      const topScaleByWrong = () => {
        const entries = Object.entries(scaleStats).filter(([, s]) => enough(s) && (s.wrong || 0) > 0);
        if (entries.length === 0) return null;
        const maxWrong = Math.max(...entries.map(([, s]) => s.wrong || 0));
        const top = entries.find(([, s]) => (s.wrong || 0) === maxWrong);
        return top ? Number(top[0]) : null;
      };
      const topJensByWrong = () => {
        const entries = Object.entries(jensStats).filter(([, s]) => enough(s) && (s.wrong || 0) > 0);
        if (entries.length === 0) return null;
        const maxWrong = Math.max(...entries.map(([, s]) => s.wrong || 0));
        const top = entries.find(([, s]) => (s.wrong || 0) === maxWrong);
        return top ? top[0] : null;
      };

      const scaleName = (id) => SCALES.find(s => s.id === id)?.name ?? id;
      const jensName = (id) => JENSES.find(j => j.id === id)?.name ?? id;

      const natScale = topScaleByCorrect();
      const natJens = topJensByCorrect();
      const hardScale = topScaleByWrong();
      const hardJens = topJensByWrong();

      if (natScale != null || natJens != null) {
        const parts = [];
        if (natScale != null) parts.push(scaleName(natScale));
        if (natJens != null) parts.push(jensName(natJens));
        naturallyEl.textContent = "You naturally hear: " + parts.join(" & ") + ".";
      } else {
        naturallyEl.textContent = "You naturally hear: ‚Äî (need ‚â•" + STATS_MIN_ATTEMPTS + " attempts per item).";
      }

      if (hardScale != null || hardJens != null) {
        const parts = [];
        if (hardScale != null) parts.push(scaleName(hardScale));
        if (hardJens != null) parts.push(jensName(hardJens));
        hardEl.textContent = "Still hard to distinguish: " + parts.join(" & ") + ".";
      } else {
        hardEl.textContent = "Still hard to distinguish: ‚Äî (need ‚â•" + STATS_MIN_ATTEMPTS + " attempts per item).";
      }
    }

    function newTest() {
      if (testIndex >= settings.totalTests) return;

      if (testMode === "jens") {
        const enabledJenses = getEnabledJenses();
        if (enabledJenses.length === 0) {
          statusEl.textContent = "Select at least one jens in Settings.";
          replayBtn.disabled = true;
          nextBtn.disabled = true;
          clearChoices();
          return;
        }
      testIndex += 1;
      answered = false;
      directionRevealed = false;
      startRevealed = false;
      hintUsed = false;

      const jens = pickWeighted(enabledJenses, j => (jensStats[j.id]?.wrong ?? 0) + 1);
        const direction = pickDirection();
        const lo = Math.min(settings.lowestMidi, settings.highestMidi);
        const hi = Math.max(settings.lowestMidi, settings.highestMidi);
        const startMidi = randIntInclusive(lo, hi);

        let midiNotes = buildScaleMidi(startMidi, jens.intervals);
        if (direction === "down") midiNotes = [...midiNotes].reverse();
        const noteNames = midiNotes.map(midiToNoteName);

        current = {
          jens,
          chosenJensId: jens.id,
          direction,
          startMidi,
          midiNotes,
          noteNames,
          availableJenses: enabledJenses
        };

        promptEl.textContent = "";
        notesOut.textContent = "-";
        nextBtn.disabled = true;
        hintBtn.disabled = false;
        renderChoices();
        setMeta();
        if (!piano) {
          statusEl.textContent = "Loading piano sound‚Ä¶";
          replayBtn.disabled = true;
          ensurePiano().then(() => {
            replayBtn.disabled = false;
            if (statusEl.textContent === "Loading piano sound‚Ä¶") statusEl.textContent = "";
            doPlay();
          });
        } else {
          statusEl.textContent = "";
          replayBtn.disabled = false;
          doPlay();
        }
        return;
      }

      const enabledScales = getEnabledScales();
      if (enabledScales.length === 0) {
        statusEl.textContent = "Select at least one scale in Settings.";
        replayBtn.disabled = true;
        nextBtn.disabled = true;
        clearChoices();
        return;
      }

      testIndex += 1;
      answered = false;
      directionRevealed = false;
      startRevealed = false;
      hintUsed = false;

      const scale = pickWeighted(enabledScales, s => (scaleStats[s.id]?.wrong ?? 0) + 1);
      const direction = pickDirection();

      const lo = Math.min(settings.lowestMidi, settings.highestMidi);
      const hi = Math.max(settings.lowestMidi, settings.highestMidi);
      const startMidi = randIntInclusive(lo, hi);

      let midiNotes = buildScaleMidi(startMidi, scale.intervals);
      if (direction === "down") midiNotes = [...midiNotes].reverse();

      const noteNames = midiNotes.map(midiToNoteName);

      current = {
        scale,
        chosenScaleId: scale.id,
        direction,
        startMidi,
        midiNotes,
        noteNames,
        availableScales: enabledScales
      };

      promptEl.textContent = "";
      notesOut.textContent = "-";
      nextBtn.disabled = true;
      hintBtn.disabled = false;
      renderChoices();
      setMeta();
      if (!piano) {
        statusEl.textContent = "Loading piano sound‚Ä¶";
        replayBtn.disabled = true;
        ensurePiano().then(() => {
          replayBtn.disabled = false;
          if (statusEl.textContent === "Loading piano sound‚Ä¶") statusEl.textContent = "";
          doPlay();
        });
      } else {
        statusEl.textContent = "";
        replayBtn.disabled = false;
        doPlay();
      }
    }

    function useHint() {
      if (!current || answered || hintUsed) return;
      const btns = [...choicesEl.querySelectorAll("button.choice:not(.hint-eliminated)")];
      const correctId = testMode === "jens" ? current.chosenJensId : current.chosenScaleId;
      const correctBtn = testMode === "jens"
        ? btns.find(b => b.dataset.jensId === correctId)
        : btns.find(b => b.textContent.startsWith(`${correctId}:`));
      const wrongBtns = btns.filter(b => b !== correctBtn);
      const toRemove = Math.min(Math.floor(wrongBtns.length / 2) + 1, wrongBtns.length);
      for (let i = wrongBtns.length - 1; i > 0 && toRemove > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [wrongBtns[i], wrongBtns[j]] = [wrongBtns[j], wrongBtns[i]];
      }
      wrongBtns.slice(0, toRemove).forEach(b => {
        b.classList.add("hint-eliminated");
        b.disabled = true;
      });
      hintUsed = true;
      hintBtn.disabled = true;
      statusEl.textContent = "Half of the wrong choices were eliminated.";
    }

    async function doPlay() {
      if (!current) return;
      if (isPlaying) return;
      isPlaying = true;
      playbackCancelled = false;
      replayBtn.disabled = true;
      nextBtn.disabled = true;
      statusEl.textContent = "Playing‚Ä¶";
      try {
        await playScale(current.midiNotes, DEFAULT_NOTE_DURATION_SEC, DEFAULT_PAUSE_DURATION_SEC);
        if (!playbackCancelled) statusEl.textContent = testMode === "jens" ? "Choose the jens." : "Choose the scale.";
      } finally {
        isPlaying = false;
        replayBtn.disabled = false;
        nextBtn.disabled = answered ? false : true;
      }
    }

    function handleGuess(guessId, clickedBtn) {
      if (!current || answered) return;
      answered = true;
      lockChoices();

      let correct, correctBtn;
      if (testMode === "jens") {
        correct = (guessId === current.chosenJensId);
        const btns = [...choicesEl.querySelectorAll("button")];
        correctBtn = btns.find(b => b.dataset.jensId === current.chosenJensId);
      } else {
        correct = (guessId === current.chosenScaleId);
        const btns = [...choicesEl.querySelectorAll("button")];
        correctBtn = btns.find(b => b.textContent.startsWith(`${current.chosenScaleId}:`));
      }
      if (correctBtn) correctBtn.classList.add("ok");
      if (!correct) clickedBtn.classList.add("bad");

      const correctId = testMode === "jens" ? current.chosenJensId : current.chosenScaleId;
      if (testMode === "jens") {
        if (!jensStats[correctId]) jensStats[correctId] = { correct: 0, wrong: 0 };
        if (correct) jensStats[correctId].correct += 1; else jensStats[correctId].wrong += 1;
      } else {
        if (!scaleStats[correctId]) scaleStats[correctId] = { correct: 0, wrong: 0 };
        if (correct) scaleStats[correctId].correct += 1; else scaleStats[correctId].wrong += 1;
      }
      saveStatsToStorage();

      if (correct) {
        correctCount += 1;
        statusEl.textContent = "‚úÖ Correct!";
      } else {
        mistakes.push({ correctId, wrongId: guessId });
        statusEl.textContent = `‚ùå Incorrect!`;
      }

      notesOut.textContent = current.noteNames.join(" ");
      nextBtn.disabled = false;
      replayBtn.disabled = false;
      hintBtn.disabled = true;
      setMeta();

      nextBtn.textContent = (testIndex === settings.totalTests) ? "Finish" : "Next";
    }

    function getMostRepeatedMistake() {
      if (mistakes.length === 0) return null;
      const countByPair = new Map();
      for (const { correctId, wrongId } of mistakes) {
        const pairKey = [String(correctId), String(wrongId)].sort().join("|");
        countByPair.set(pairKey, (countByPair.get(pairKey) || 0) + 1);
      }
      let maxCount = 0;
      let bestKey = null;
      for (const [key, count] of countByPair) {
        if (count > maxCount) { maxCount = count; bestKey = key; }
      }
      if (!bestKey) return null;
      const [idA, idB] = bestKey.split("|");
      const id1 = testMode === "jens" ? idA : Number(idA);
      const id2 = testMode === "jens" ? idB : Number(idB);
      const name1 = testMode === "jens"
        ? (JENSES.find(j => j.id === id1)?.name ?? id1)
        : (SCALES.find(s => s.id === id1)?.name ?? `${id1}`);
      const name2 = testMode === "jens"
        ? (JENSES.find(j => j.id === id2)?.name ?? id2)
        : (SCALES.find(s => s.id === id2)?.name ?? `${id2}`);
      return { name1, name2, count: maxCount };
    }

    function finishIfDone() {
      if (testIndex < settings.totalTests) return false;
      testArea.classList.add("done");
      promptEl.textContent = "";
      const finalScoreEl = document.getElementById("finalScoreDisplay");
      if (finalScoreEl) finalScoreEl.textContent = `Final score: ${correctCount} / ${settings.totalTests}`;

      const pct = settings.totalTests > 0 ? (100 * correctCount / settings.totalTests) : 0;
      const doneMessage = document.getElementById("doneMessage");
      doneMessage.className = "done-message";
      if (correctCount === settings.totalTests) {
        doneMessage.textContent = "PERFECT!";
        doneMessage.classList.add("perfect");
      } else if (pct > 80) {
        doneMessage.textContent = "Great!";
        doneMessage.classList.add("great");
      } else if (pct >= 50) {
        doneMessage.textContent = "Good!";
        doneMessage.classList.add("good");
      } else {
        doneMessage.textContent = "The scales are shy today, they'll sound better in the next round! :))";
        doneMessage.classList.add("shy");
      }

      const top = getMostRepeatedMistake();
      statusEl.textContent = (top && top.count > 3)
        ? `You mix up ${top.name1} and ${top.name2} more often (${top.count} times).`
        : "";

      replayBtn.disabled = true;
      hintBtn.disabled = true;
      nextBtn.disabled = true;
      clearChoices();
      setMeta();
      return true;
    }

    function restart() {
      testMode = null;
      testIndex = 0;
      correctCount = 0;
      mistakes = [];
      current = null;
      answered = false;
      directionRevealed = false;
      startRevealed = false;

      mainMenu.classList.remove("hidden");
      testArea.classList.remove("visible");
      promptEl.textContent = "Choose test type: Scale or Jens.";
      statusEl.textContent = "";
      notesOut.textContent = "-";

      replayBtn.disabled = true;
      hintBtn.disabled = true;
      nextBtn.disabled = true;
      nextBtn.textContent = "Next";

      clearChoices();
      setMeta();
    }

    function enterTestMode(mode) {
      testMode = mode;
      testIndex = 0;
      correctCount = 0;
      mistakes = [];
      current = null;
      answered = false;
      directionRevealed = false;
      startRevealed = false;
      testArea.classList.remove("done");
      const doneMessageEl = document.getElementById("doneMessage");
      if (doneMessageEl) { doneMessageEl.textContent = ""; doneMessageEl.className = "done-message"; }
      const finalScoreEl = document.getElementById("finalScoreDisplay");
      if (finalScoreEl) finalScoreEl.textContent = "";
      mainMenu.classList.add("hidden");
      testArea.classList.add("visible");
      promptEl.textContent = "Press \"Start Test\" to begin.";
      statusEl.textContent = "";
      notesOut.textContent = "-";
      clearChoices();
      setMeta();
      replayBtn.disabled = true;
      hintBtn.disabled = true;
      nextBtn.disabled = true;
      nextBtn.textContent = "Next";
    }

    // ===== Settings UI wiring =====
    function buildScaleChecklist() {
      scaleChecklistEl.innerHTML = "";
      for (const s of SCALES) {
        const row = document.createElement("label");
        row.className = "chk";

        const cb = document.createElement("input");
        cb.type = "checkbox";
        cb.checked = settings.enabledScaleIds.has(s.id);
        cb.dataset.scaleId = String(s.id);

        const text = document.createElement("div");
        text.textContent = `${s.id}: ${s.name}`;

        row.appendChild(cb);
        row.appendChild(text);
        scaleChecklistEl.appendChild(row);
      }
    }

    function buildJensChecklist() {
      jensChecklistEl.innerHTML = "";
      for (const j of JENSES) {
        const row = document.createElement("label");
        row.className = "chk";

        const cb = document.createElement("input");
        cb.type = "checkbox";
        cb.checked = settings.enabledJensIds.has(j.id);
        cb.dataset.jensId = j.id;

        const text = document.createElement("div");
        text.textContent = j.name;

        row.appendChild(cb);
        row.appendChild(text);
        jensChecklistEl.appendChild(row);
      }
    }

    function buildNoteSelectOptions(selectEl) {
      // C2..C6 inclusive
      const startMidi = noteNameToMidi("C2"); // 36
      const endMidi = noteNameToMidi("C6");   // 84
      selectEl.innerHTML = "";
      for (let m = startMidi; m <= endMidi; m += 1) {
        const opt = document.createElement("option");
        opt.value = String(m);
        opt.textContent = midiToNoteName(m);
        selectEl.appendChild(opt);
      }
    }

    function setSettingsInputsFromState() {
      buildNoteSelectOptions(lowestNoteEl);
      buildNoteSelectOptions(highestNoteEl);

      lowestNoteEl.value = String(settings.lowestMidi);
      highestNoteEl.value = String(settings.highestMidi);
      directionModeEl.value = settings.directionMode;
      totalTestsEl.value = String(settings.totalTests);

      buildScaleChecklist();
      buildJensChecklist();
      setMeta();
      testMeta.textContent = `Test: ${testIndex} / ${settings.totalTests}`;
    }

    function applySettingsFromInputs() {
      // lowest/highest notes
      settings.lowestMidi = clampInt(lowestNoteEl.value, 0, 127);
      settings.highestMidi = clampInt(highestNoteEl.value, 0, 127);

      // direction
      const dm = directionModeEl.value;
      settings.directionMode = (dm === "up" || dm === "down" || dm === "random") ? dm : "random";

      // tests
      settings.totalTests = clampInt(totalTestsEl.value, 1, 1000000);

      // scale selection
      const newSet = new Set();
      const boxes = [...scaleChecklistEl.querySelectorAll('input[type="checkbox"]')];
      for (const cb of boxes) {
        if (cb.checked) newSet.add(Number(cb.dataset.scaleId));
      }
      settings.enabledScaleIds = newSet;

      // jens selection
      const newJensSet = new Set();
      const jensBoxes = [...jensChecklistEl.querySelectorAll('input[type="checkbox"]')];
      for (const cb of jensBoxes) {
        if (cb.checked) newJensSet.add(cb.dataset.jensId);
      }
      settings.enabledJensIds = newJensSet;

      saveSettingsToStorage();
      testMeta.textContent = `Test: ${testIndex} / ${settings.totalTests}`;
      setMeta();
    }

    selectAllBtn.addEventListener("click", () => {
      const boxes = [...scaleChecklistEl.querySelectorAll('input[type="checkbox"]')];
      for (const cb of boxes) cb.checked = true;
    });

    selectNoneBtn.addEventListener("click", () => {
      const boxes = [...scaleChecklistEl.querySelectorAll('input[type="checkbox"]')];
      for (const cb of boxes) cb.checked = false;
    });

    selectAllJensBtn.addEventListener("click", () => {
      const boxes = [...jensChecklistEl.querySelectorAll('input[type="checkbox"]')];
      for (const cb of boxes) cb.checked = true;
    });

    selectNoneJensBtn.addEventListener("click", () => {
      const boxes = [...jensChecklistEl.querySelectorAll('input[type="checkbox"]')];
      for (const cb of boxes) cb.checked = false;
    });

    applySettingsBtn.addEventListener("click", () => {
      applySettingsFromInputs();
      statusEl.textContent = "Settings applied.";
    });

    // ===== Events =====
    startBtn.addEventListener("click", () => {
      if (testIndex === 0 || testIndex < settings.totalTests) newTest();
    });

    replayBtn.addEventListener("click", doPlay);
    hintBtn.addEventListener("click", useHint);

    nextBtn.addEventListener("click", () => {
      playbackCancelled = true;
      if (finishIfDone()) return;
      newTest();
    });

    restartBtn.addEventListener("click", () => {
      playbackCancelled = true;
      restart();
    });

    const settingsBtn = document.getElementById("settingsBtn");
    const settingsPanel = document.getElementById("settingsPanel");
    const settingsBackBtn = document.getElementById("settingsBackBtn");
    settingsBtn.addEventListener("click", () => {
      settingsPanel.classList.add("visible");
      mainMenu.classList.add("hidden");
    });

    const statsBtn = document.getElementById("statsBtn");
    const statsModal = document.getElementById("statsModal");
    const statsModalClose = document.getElementById("statsModalClose");
    if (statsBtn && statsModal) {
      statsBtn.addEventListener("click", () => {
        refreshStatsDisplay();
        statsModal.classList.add("visible");
        statsModal.setAttribute("aria-hidden", "false");
      });
    }
    if (statsModalClose && statsModal) {
      statsModalClose.addEventListener("click", () => {
        statsModal.classList.remove("visible");
        statsModal.setAttribute("aria-hidden", "true");
      });
      statsModal.addEventListener("click", (e) => {
        if (e.target === statsModal) {
          statsModal.classList.remove("visible");
          statsModal.setAttribute("aria-hidden", "true");
        }
      });
    }
    const statsClearHistoryBtn = document.getElementById("statsClearHistoryBtn");
    if (statsClearHistoryBtn) {
      statsClearHistoryBtn.addEventListener("click", () => {
        if (confirm("Clear all practice history (correct and wrong counts)?")) {
          clearStatsHistory();
        }
      });
    }
    settingsBackBtn.addEventListener("click", () => {
      settingsPanel.classList.remove("visible");
      mainMenu.classList.remove("hidden");
    });

    const helpBtn = document.getElementById("helpBtn");
    const helpModal = document.getElementById("helpModal");
    const helpModalClose = document.getElementById("helpModalClose");
    helpBtn.addEventListener("click", () => {
      helpModal.classList.add("visible");
      helpModal.setAttribute("aria-hidden", "false");
    });
    helpModalClose.addEventListener("click", () => {
      helpModal.classList.remove("visible");
      helpModal.setAttribute("aria-hidden", "true");
    });
    helpModal.addEventListener("click", (e) => {
      if (e.target === helpModal) {
        helpModal.classList.remove("visible");
        helpModal.setAttribute("aria-hidden", "true");
      }
    });

    const learnModal = document.getElementById("learnModal");
    const learnModalClose = document.getElementById("learnModalClose");
    const learnTabScales = document.getElementById("learnTabScales");
    const learnTabJens = document.getElementById("learnTabJens");
    const learnListEl = document.getElementById("learnList");
    const learnTonicSelect = document.getElementById("learnTonicSelect");
    const learnDirectionSelect = document.getElementById("learnDirectionSelect");
    const defaultTonicMidi = noteNameToMidi("C4");

    function renderLearnList(mode) {
      if (!learnListEl) return;
      learnListEl.innerHTML = "";
      const items = mode === "jens" ? JENSES : SCALES;
      for (const item of items) {
        const card = document.createElement("div");
        card.className = "learn-item";
        const title = document.createElement("div");
        title.className = "learn-item-title";
        title.textContent = item.name;
        const pattern = document.createElement("div");
        pattern.className = "learn-item-pattern";
        pattern.textContent = "Semitones pattern: " + item.intervals.join(", ");
        const desc = document.createElement("div");
        desc.className = "learn-item-desc";
        desc.textContent = item.description || "";
        const playRow = document.createElement("div");
        playRow.className = "learn-item-play-row";
        const playBtn = document.createElement("button");
        playBtn.type = "button";
        playBtn.textContent = "Play";
        playBtn.addEventListener("click", () => {
          learnPlaySessionId += 1;
          const sessionId = learnPlaySessionId;
          const tonicMidi = learnTonicSelect ? parseInt(learnTonicSelect.value, 10) : defaultTonicMidi;
          let notes = buildScaleMidi(tonicMidi, item.intervals);
          const dir = learnDirectionSelect && learnDirectionSelect.value === "down" ? "down" : "up";
          if (dir === "down") notes = [...notes].reverse();
          (async () => {
            await playScaleForLearn(notes, sessionId, DEFAULT_NOTE_DURATION_SEC, DEFAULT_PAUSE_DURATION_SEC);
          })();
        });
        playRow.appendChild(playBtn);
        card.appendChild(title);
        card.appendChild(pattern);
        card.appendChild(desc);
        card.appendChild(playRow);
        learnListEl.appendChild(card);
      }
    }

    const learnBtn = document.getElementById("learnBtn");
    if (learnBtn && learnModal) {
      learnBtn.addEventListener("click", () => {
        playbackCancelled = true;
        if (learnTonicSelect) {
          buildNoteSelectOptions(learnTonicSelect);
          learnTonicSelect.value = String(defaultTonicMidi);
        }
        renderLearnList("scale");
        if (learnTabScales) { learnTabScales.classList.add("active"); }
        if (learnTabJens) { learnTabJens.classList.remove("active"); }
        learnModal.classList.add("visible");
        learnModal.setAttribute("aria-hidden", "false");
      });
    }
    if (learnTabScales) {
      learnTabScales.addEventListener("click", () => {
        renderLearnList("scale");
        learnTabScales.classList.add("active");
        if (learnTabJens) learnTabJens.classList.remove("active");
      });
    }
    if (learnTabJens) {
      learnTabJens.addEventListener("click", () => {
        renderLearnList("jens");
        learnTabJens.classList.add("active");
        if (learnTabScales) learnTabScales.classList.remove("active");
      });
    }
    if (learnModalClose && learnModal) {
      learnModalClose.addEventListener("click", () => {
        playbackCancelled = true;
        learnModal.classList.remove("visible");
        learnModal.setAttribute("aria-hidden", "true");
      });
      learnModal.addEventListener("click", (e) => {
        if (e.target === learnModal) {
          playbackCancelled = true;
          learnModal.classList.remove("visible");
          learnModal.setAttribute("aria-hidden", "true");
        }
      });
    }

    scaleTestBtn.addEventListener("click", () => enterTestMode("scale"));
    jensTestBtn.addEventListener("click", () => enterTestMode("jens"));

    dirMeta.addEventListener("click", () => {
      if (current && !directionRevealed) { directionRevealed = true; setMeta(); }
    });
    startMeta.addEventListener("click", () => {
      if (current && !startRevealed) { startRevealed = true; setMeta(); }
    });

    // Keyboard shortcuts
    document.addEventListener("keydown", (e) => {
      const tag = document.activeElement?.tagName?.toLowerCase();
      if (tag === "input" || tag === "select" || tag === "textarea") return;

      if (e.code === "Space") {
        e.preventDefault();
        if (!replayBtn.disabled) doPlay();
      } else if (e.code === "Enter") {
        e.preventDefault();
        if (!nextBtn.disabled) {
          if (finishIfDone()) return;
          newTest();
        } else if (testArea.classList.contains("visible") && testIndex === 0) {
          newTest();
        }
      } else if (e.code === "Escape") {
        e.preventDefault();
        const helpModal = document.getElementById("helpModal");
        const statsModal = document.getElementById("statsModal");
        const learnModal = document.getElementById("learnModal");
        if (helpModal && helpModal.classList.contains("visible")) {
          helpModal.classList.remove("visible");
          helpModal.setAttribute("aria-hidden", "true");
        } else if (statsModal && statsModal.classList.contains("visible")) {
          statsModal.classList.remove("visible");
          statsModal.setAttribute("aria-hidden", "true");
        } else if (learnModal && learnModal.classList.contains("visible")) {
          playbackCancelled = true;
          learnModal.classList.remove("visible");
          learnModal.setAttribute("aria-hidden", "true");
        } else if (settingsPanel.classList.contains("visible")) {
          settingsPanel.classList.remove("visible");
          mainMenu.classList.remove("hidden");
        } else if (testArea.classList.contains("visible")) {
          restart();
        }
      } else {
        // 1-9 -> choices 1-9, Minus -> choice 10
        const choiceBtns = [...choicesEl.querySelectorAll("button.choice:not(.hint-eliminated)")].filter(b => !b.disabled);
        let idx = -1;
        if (e.code >= "Digit1" && e.code <= "Digit9") idx = parseInt(e.code.replace("Digit", ""), 10) - 1;
        else if (e.code === "Minus") idx = 9;
        if (idx >= 0 && choiceBtns[idx]) {
          e.preventDefault();
          choiceBtns[idx].click();
        }
      }
    });

    // init
    loadSettingsFromStorage();
    loadStatsFromStorage();
    setSettingsInputsFromState();
    restart();
  </script>
</body>
</html>
